<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>হাসানিয়া পরীক্ষা পরিচালনা ব্যবস্থা (HEMS)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Hind Siliguri -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF & Excel Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Default font set to Hind Siliguri */
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
            transition: font-family 0.3s ease-in-out;
        }
        /* Class for SolaimanLipi */
        .font-solaiman {
            font-family: 'SolaimanLipi', 'Hind Siliguri', sans-serif;
        }
        /* Class for Hind Siliguri (explicitly) */
        .font-hind-siliguri {
            font-family: 'Hind Siliguri', sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        .lucide {
            width: 1rem;
            height: 1rem;
            stroke-width: 2;
        }
        .modal {
            display: none;
        }
        .modal.is-open {
            display: flex;
        }
        /* Custom animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <!-- Navbar -->
    <nav class="bg-gray-800 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="text-xl font-bold text-cyan-400">HEMS</div>
                <div id="desktop-nav" class="hidden md:flex space-x-2 lg:space-x-4">
                    <!-- Nav items will be injected here by JS -->
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-300 hover:text-white focus:outline-none">
                        <svg class="lucide lucide-menu" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-nav" class="hidden md:hidden pb-4 px-2">
            <!-- Mobile nav items will be injected here by JS -->
        </div>
    </nav>

    <!-- Main Content -->
    <main class="p-4 md:p-8">
        <div id="loader" class="text-center p-10">লোড হচ্ছে...</div>
        
        <!-- Home Page -->
        <div id="page-home" class="page">
            <div class="text-center">
                <header class="bg-gray-800 rounded-lg p-8 shadow-xl">
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">হাসানিয়া পরীক্ষা পরিচালনা ব্যবস্থা</h1>
                    <p class="text-cyan-400 text-lg md:text-xl">(Hasania Exam Management System - HEMS)</p>
                </header>
                <div id="home-cards" class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards will be injected by JS -->
                </div>
            </div>
        </div>

        <!-- Attendance Page -->
        <div id="page-attendance" class="page space-y-6">
             <h2 class="text-3xl font-bold text-cyan-400">পরীক্ষার্থী হাজিরা</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-gray-800 rounded-lg">
                <div>
                    <label for="att-year" class="block text-sm font-medium text-gray-300 mb-1">শিক্ষাবর্ষ</label>
                    <select id="att-year" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 text-white"></select>
                </div>
                <div>
                    <label for="att-exam" class="block text-sm font-medium text-gray-300 mb-1">পরীক্ষার ধরণ</label>
                    <select id="att-exam" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 text-white"></select>
                </div>
                <div>
                    <label for="att-jamat" class="block text-sm font-medium text-gray-300 mb-1">জামাত</label>
                    <select id="att-jamat" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 text-white"></select>
                </div>
                 <div>
                    <label for="att-date" class="block text-sm font-medium text-gray-300 mb-1">পরীক্ষার তারিখ</label>
                    <input type="date" id="att-date" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 text-white"/>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg shadow-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead id="attendance-table-head" class="bg-gray-700"></thead>
                    <tbody id="attendance-table-body" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button id="save-attendance-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 flex items-center space-x-2">
                    <svg class="lucide lucide-save" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    <span>হাজিরা সংরক্ষণ করুন</span>
                </button>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="page-reports" class="page space-y-6">
            <h2 class="text-3xl font-bold text-cyan-400">রিপোর্ট ডাউনলোড</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-gray-800 rounded-lg">
                <div>
                    <label for="rep-year" class="block text-sm font-medium text-gray-300 mb-1">শিক্ষাবর্ষ</label>
                    <select id="rep-year" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 text-white"></select>
                </div>
                <div>
                    <label for="rep-exam" class="block text-sm font-medium text-gray-300 mb-1">পরীক্ষার ধরণ</label>
                    <select id="rep-exam" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 text-white"></select>
                </div>
                <div>
                    <label for="rep-jamat" class="block text-sm font-medium text-gray-300 mb-1">জামাত</label>
                    <select id="rep-jamat" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 text-white"></select>
                </div>
            </div>
             <div class="flex justify-center">
                <button id="fetch-report-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">
                    ডেটা আনুন
                </button>
            </div>
            <div id="report-download-buttons" class="hidden bg-gray-800 p-6 rounded-lg text-center animate-fade-in">
                 <p class="text-lg text-green-400 mb-4">ডেটা সফলভাবে লোড হয়েছে। এখন রিপোর্ট ডাউনলোড করুন।</p>
                 <div class="flex justify-center space-x-4">
                     <button id="download-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2">
                         <svg class="lucide lucide-file-text" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M10 9H8"></path><path d="M16 13H8"></path><path d="M16 17H8"></path></svg>
                         <span>PDF ডাউনলোড</span>
                     </button>
                     <button id="download-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2">
                         <svg class="lucide lucide-sheet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>
                         <span>Excel ডাউনলোড</span>
                     </button>
                 </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="page space-y-6">
            <div class="flex items-center space-x-4">
                <button id="settings-back-btn" class="hidden p-2 bg-gray-700 rounded-full hover:bg-gray-600">
                    <svg class="lucide lucide-arrow-left" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                </button>
                <h2 id="settings-title" class="text-3xl font-bold text-cyan-400">সেটিংস</h2>
            </div>
            
            <div id="settings-content">
                <!-- Settings Main Menu -->
                <div id="settings-main" class="space-y-6"></div>
                <!-- Subpages will be rendered here -->
            </div>
        </div>
        
        <!-- Introduction Page -->
        <div id="page-introduction" class="page">
             <div class="bg-gray-800 p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-cyan-400 mb-4">জামিয়া হাসানিয়া কওমীয়া মাদরাসা ও এতিমখানা</h2>
                <p class="text-gray-300 leading-relaxed">
                    জামিয়া হাসানিয়া কওমীয়া মাদরাসা ও এতিমখানা নড়াইল জেলার কালিয়া উপজেলার রঘুনাথপুর গ্রামে অবস্থিত একটি ঐতিহ্যবাহী দ্বীনি শিক্ষা প্রতিষ্ঠান। যুগশ্রেষ্ঠ আলেমদের তত্ত্বাবধানে পরিচালিত এই মাদরাসাটি এলাকার দ্বীনি শিক্ষার প্রসারে গুরুত্বপূর্ণ ভূমিকা পালন করে আসছে। এখানে শিক্ষার্থীদেরকে কুরআন, হাদীস, ফিকহসহ বিভিন্ন বিষয়ে গভীর জ্ঞান দান করা হয় এবং একই সাথে নৈতিক ও চারিত্রিক গঠনেও গুরুত্ব দেওয়া হয়।
                </p>
            </div>
        </div>
        
        <!-- About Page -->
        <div id="page-about" class="page">
            <div class="bg-gray-800 p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-cyan-400 mb-4">HEMS সম্পর্কে</h2>
                <p class="text-gray-300 leading-relaxed mb-4">
                    Hasania Exam Management System (HEMS) হলো জামিয়া হাসানিয়া কওমীয়া মাদরাসার পরীক্ষা সংক্রান্ত কার্যক্রম আধুনিক ও সহজ করার একটি ডিজিটাল উদ্যোগ। এই সিস্টেমের মাধ্যমে শিক্ষার্থীদের হাজিরা গ্রহণ, ফলাফল তৈরি এবং রিপোর্ট ব্যবস্থাপনার মতো জটিল কাজগুলো অত্যন্ত সহজে এবং নির্ভুলভাবে সম্পন্ন করা যায়।
                </p>
                 <h3 class="text-xl font-bold text-cyan-500 mb-2">উদ্দেশ্য:</h3>
                 <ul class="list-disc list-inside text-gray-300 space-y-1">
                     <li>পরীক্ষার হাজিরা প্রক্রিয়াকে ডিজিটাল করা।</li>
                     <li>স্বয়ংক্রিয়ভাবে রিপোর্ট (PDF/Excel) তৈরি করা।</li>
                     <li>তথ্য সংরক্ষণ ও ব্যবস্থাপনাকে সহজ ও নিরাপদ করা।</li>
                     <li>প্রশাসনিক কাজের সময় বাঁচানো এবং কার্যকারিতা বৃদ্ধি করা।</li>
                 </ul>
            </div>
        </div>

    </main>

    <!-- Generic Modal -->
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-70 justify-center items-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm animate-fade-in">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-cyan-400"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel" class="py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-md text-white font-semibold">বাতিল</button>
                <button id="modal-confirm" class="py-2 px-4 bg-cyan-600 hover:bg-cyan-700 rounded-md text-white font-semibold">নিশ্চিত করুন</button>
            </div>
        </div>
    </div>
    
    <!-- Student Form Modal -->
    <div id="student-modal" class="modal fixed inset-0 bg-black bg-opacity-70 justify-center items-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md animate-fade-in">
            <h3 id="student-modal-title" class="text-2xl font-bold mb-6 text-white"></h3>
            <form id="student-form" class="space-y-4">
                <input type="hidden" id="student-id">
                <input type="text" id="student-name" placeholder="নাম" required class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
                <input type="number" id="student-roll" placeholder="রোল" required class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
                <select id="student-jamat" required class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <option value="">জামাত নির্বাচন করুন</option>
                </select>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="student-modal-cancel" class="py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-md text-white">বাতিল</button>
                    <button type="submit" id="student-modal-submit" class="py-2 px-4 bg-cyan-600 hover:bg-cyan-700 rounded-md text-white">যোগ করুন</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, onSnapshot, 
            collection, addDoc, deleteDoc, updateDoc, query, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfigString = typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : JSON.stringify({
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            });
        const firebaseConfig = JSON.parse(firebaseConfigString);

        // --- App ID and Firebase Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hems-default-app';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const basePath = `artifacts/${appId}/public/data`;

        // --- State Management ---
        const state = {
            userId: null,
            currentPage: 'home',
            academicYears: [],
            jamats: {},
            students: [],
            attendance: {},
            selectedFilters: {
                year: '',
                exam: '১ম সাময়িক পরীক্ষা',
                jamat: '',
                date: new Date().toISOString().split('T')[0],
            },
            reportData: null,
            editingJamatId: null,
            kitabNamesCache: [],
        };
        
        // --- SolaimanLipi Font Data (for jsPDF) ---
        const SolaimanLipi = {
            // IMPORTANT: This is a placeholder. For PDF generation to work, 
            // you must replace this with the full base64 encoded string of the SolaimanLipi.ttf font file.
            font: "AAEAAAARAQAABAAQRFNJRwAAAAEAA... (very long base64 string)"
        };
        
        const initialJamats = {
          'takmil': { name: 'তাকমীল', kitabCount: 10 }, 'mishkat': { name: 'মিশকাত', kitabCount: 8 },
          'jalalain': { name: 'জালালাইন', kitabCount: 7 }, 'sharhe-bekaya': { name: 'শরহে বেকায়া', kitabCount: 7 },
          'sharhe-jami': { name: 'শরহে জামী', kitabCount: 7 }, 'kafiya': { name: 'কাফিয়া', kitabCount: 9 },
          'hidayatunnahu': { name: 'হিদায়াতুন্নাহু', kitabCount: 7 }, 'nahbemir': { name: 'নাহবেমীর', kitabCount: 7 },
          'mizhan': { name: 'মিঝান', kitabCount: 9 }, 'dahom': { name: 'দহম', kitabCount: 8 },
          'iyaz-dahom': { name: 'ইয়াজ দহম', kitabCount: 10 }
        };

        const examTypes = ['১ম সাময়িক পরীক্ষা', '২য় সাময়িক পরীক্ষা', 'বার্ষিক পরীক্ষা'];


        // --- UI Elements ---
        const pages = document.querySelectorAll('.page');
        const loader = document.getElementById('loader');
        
        // --- Modal Logic ---
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        let confirmCallback = null;

        function showModal(title, message, onConfirm = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            if (onConfirm) {
                modalConfirm.style.display = 'block';
                modalCancel.textContent = 'বাতিল';
            } else {
                modalConfirm.style.display = 'none';
                modalCancel.textContent = 'বন্ধ করুন';
            }
            modal.classList.add('is-open');
        }

        function closeModal() {
            modal.classList.remove('is-open');
            confirmCallback = null;
        }

        modalCancel.addEventListener('click', closeModal);
        modalConfirm.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeModal();
        });

        // --- Helper Functions ---
        function populateSelect(element, data, valueProp, textProp, options = {}) {
            element.innerHTML = `<option value="">${options.placeholder || 'নির্বাচন করুন'}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueProp];
                option.textContent = typeof textProp === 'function' ? textProp(item) : item[textProp];
                element.appendChild(option);
            });
        }


        // --- Navigation ---
        const navItems = [
            { id: 'home', label: 'হোম', icon: `<svg class="lucide lucide-home" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>` },
            { id: 'attendance', label: 'পরীক্ষার্থী হাজিরা', icon: `<svg class="lucide lucide-user" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>` },
            { id: 'reports', label: 'রিপোর্ট ডাউনলোড', icon: `<svg class="lucide lucide-download" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>` },
            { id: 'introduction', label: 'জামিয়ার পরিচয়', icon: `<svg class="lucide lucide-book" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>` },
            { id: 'settings', label: 'সেটিংস', icon: `<svg class="lucide lucide-settings-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 7h-9"/><path d="M14 17H4"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>` },
            { id: 'about', label: 'HEMS সম্পর্কে', icon: `<svg class="lucide lucide-info" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>` },
        ];
        const desktopNav = document.getElementById('desktop-nav');
        const mobileNav = document.getElementById('mobile-nav');
        const mobileMenuButton = document.getElementById('mobile-menu-button');

        function navigate(pageId) {
            state.currentPage = pageId;
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            if (pageId === 'settings') {
                renderSettingsMain();
            }

            const allNavButtons = document.querySelectorAll('.nav-btn');
            allNavButtons.forEach(btn => {
                btn.classList.remove('bg-cyan-500', 'text-white');
                btn.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                if (btn.dataset.page === pageId) {
                    btn.classList.add('bg-cyan-500', 'text-white');
                }
            });

            mobileNav.classList.add('hidden');
        }

        mobileMenuButton.addEventListener('click', () => mobileNav.classList.toggle('hidden'));
        
        function renderNav() {
            desktopNav.innerHTML = navItems.map(item => `
                <button data-page="${item.id}" class="nav-btn flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                    ${item.icon.replace('class="lucide', 'class="lucide w-4 h-4"')}
                    <span>${item.label}</span>
                </button>
            `).join('');
            
            mobileNav.innerHTML = navItems.map(item => `
                 <button data-page="${item.id}" class="nav-btn flex items-center w-full text-left space-x-3 px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                     ${item.icon.replace('class="lucide', 'class="lucide w-5 h-5"')}
                     <span>${item.label}</span>
                 </button>
            `).join('');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => navigate(btn.dataset.page));
            });
        }
        
        function renderHome() {
            const homeContainer = document.getElementById('home-cards');
            const cardData = [
                { page: 'attendance', icon: navItems[1].icon, title: 'হাজিরা নিন', desc: 'শিক্ষাবর্ষ, জামাত ও পরীক্ষা নির্বাচন করে সহজেই শিক্ষার্থীদের হাজিরা নিন।'},
                { page: 'reports', icon: navItems[2].icon, title: 'রিপোর্ট ডাউনলোড', desc: 'শিক্ষার্থীদের উপস্থিতির বিস্তারিত রিপোর্ট পিডিএফ বা এক্সেল ফরম্যাটে ডাউনলোড করুন।'},
                { page: 'settings', icon: navItems[4].icon, title: 'সিস্টেম সেটিংস', desc: 'জামাত, কিতাব এবং শিক্ষাবর্ষ পরিচালনা করুন।'},
            ];
            homeContainer.innerHTML = cardData.map(card => `
                <div data-page="${card.page}" class="home-card bg-gray-800 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-gray-700 hover:shadow-cyan-500/20 shadow-lg transition-all duration-300 transform hover:-translate-y-2">
                    <div class="text-cyan-400 mb-4">${card.icon.replace('class="lucide', 'class="lucide w-10 h-10"')}</div>
                    <h3 class="text-xl font-bold text-white mb-2">${card.title}</h3>
                    <p class="text-gray-400 text-sm">${card.desc}</p>
                </div>
            `).join('');

            document.querySelectorAll('.home-card').forEach(card => {
                card.addEventListener('click', () => navigate(card.dataset.page));
            });
        }
        
        const attYearSelect = document.getElementById('att-year');
        const attExamSelect = document.getElementById('att-exam');
        const attJamatSelect = document.getElementById('att-jamat');
        const attDateInput = document.getElementById('att-date');
        const attTableHead = document.getElementById('attendance-table-head');
        const attTableBody = document.getElementById('attendance-table-body');
        const saveAttendanceBtn = document.getElementById('save-attendance-btn');

        function renderAttendanceTable() {
            const jamatId = state.selectedFilters.jamat;
            const currentJamat = state.jamats[jamatId];
            if (!currentJamat) {
                 attTableHead.innerHTML = '';
                 attTableBody.innerHTML = `<tr><td class="text-center py-8 text-gray-400">জামাত নির্বাচন করুন।</td></tr>`;
                 return;
            }

            const kitabNames = currentJamat.kitabNames || Array.from({ length: currentJamat.kitabCount }, (_, i) => `কিতাব নং ${i + 1}`);
            const filteredStudents = state.students.filter(s => s.jamatId === jamatId).sort((a,b) => (a.roll || 0) - (b.roll || 0));

            attTableHead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 text-right text-sm font-semibold text-gray-300 uppercase tracking-wider sticky left-0 bg-gray-700 z-10">ছাত্রের নাম</th>
                    ${kitabNames.map(kitab => `<th class="px-6 py-3 text-center text-sm font-semibold text-gray-300 uppercase tracking-wider whitespace-nowrap">${kitab}</th>`).join('')}
                </tr>
            `;

            if (filteredStudents.length === 0) {
                 attTableBody.innerHTML = `<tr><td colspan="${kitabNames.length + 1}" class="text-center py-8 text-gray-400">এই জামাতে কোনো শিক্ষার্থী পাওয়া যায়নি।</td></tr>`;
                 return;
            }

            attTableBody.innerHTML = filteredStudents.map(student => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white sticky left-0 bg-gray-800 z-10">${student.name} (রোল: ${student.roll})</td>
                    ${kitabNames.map((_, kitabIndex) => {
                        const isPresent = state.attendance[student.id]?.[kitabIndex] === 'present';
                        const isAbsent = state.attendance[student.id]?.[kitabIndex] === 'absent';
                        return `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                           <div class="flex items-center justify-center space-x-4">
                               <label class="flex items-center cursor-pointer">
                                   <input type="radio" data-student-id="${student.id}" data-kitab-index="${kitabIndex}" value="present" name="att-${student.id}-${kitabIndex}" class="attendance-radio hidden" ${isPresent ? 'checked' : ''}>
                                   <span class="w-5 h-5 rounded-full border-2 flex items-center justify-center ${isPresent ? 'bg-cyan-500 border-cyan-500' : 'border-gray-500'}">
                                       ${isPresent ? '<span class="w-2 h-2 bg-white rounded-full"></span>' : ''}
                                   </span>
                               </label>
                               <label class="flex items-center cursor-pointer">
                                   <input type="radio" data-student-id="${student.id}" data-kitab-index="${kitabIndex}" value="absent" name="att-${student.id}-${kitabIndex}" class="attendance-radio hidden" ${isAbsent ? 'checked' : ''}>
                                    <span class="w-5 h-5 rounded-full border-2 flex items-center justify-center ${isAbsent ? 'bg-red-500 border-red-500' : 'border-gray-500'}">
                                       ${isAbsent ? '<span class="w-2 h-2 bg-white rounded-full"></span>' : ''}
                                   </span>
                               </label>
                           </div>
                       </td>
                    `}).join('')}
                </tr>
            `).join('');
        }

        attTableBody.addEventListener('change', e => {
            if (e.target.classList.contains('attendance-radio')) {
                const { studentId, kitabIndex } = e.target.dataset;
                const status = e.target.value;
                if (!state.attendance[studentId]) {
                    state.attendance[studentId] = {};
                }
                state.attendance[studentId][kitabIndex] = status;
                renderAttendanceTable();
            }
        });
        
        async function fetchAttendance() {
            const { year, exam, jamat } = state.selectedFilters;
            if(!year || !exam || !jamat) return;

            const attendanceId = `${year}_${exam.replace(/\s/g, '-')}_${jamat}`;
            const attendanceRef = doc(db, `${basePath}/attendance`, attendanceId);
            const docSnap = await getDoc(attendanceRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                state.attendance = data.records || {};
                state.selectedFilters.date = data.date || state.selectedFilters.date;
                attDateInput.value = state.selectedFilters.date;
            } else {
                state.attendance = {};
            }
            renderAttendanceTable();
        }

        [attYearSelect, attExamSelect, attJamatSelect].forEach(el => {
            el.addEventListener('change', e => {
                const key = el.id.split('-')[1];
                state.selectedFilters[key] = e.target.value;
                fetchAttendance();
            });
        });
        attDateInput.addEventListener('change', e => {
            state.selectedFilters.date = e.target.value;
        });

        saveAttendanceBtn.addEventListener('click', async () => {
             const { year, exam, jamat, date } = state.selectedFilters;
             if (!year || !exam || !jamat) {
                showModal("ত্রুটি", "অনুগ্রহ করে শিক্ষাবর্ষ, পরীক্ষা এবং জামাত নির্বাচন করুন।");
                return;
             }
             const attendanceId = `${year}_${exam.replace(/\s/g, '-')}_${jamat}`;
             const attendanceRef = doc(db, `${basePath}/attendance`, attendanceId);
             try {
                await setDoc(attendanceRef, {
                    yearId: year, examType: exam, jamatId: jamat, date: date,
                    records: state.attendance, updatedAt: new Date().toISOString()
                }, { merge: true });
                showModal('সফল', 'হাজিরা সফলভাবে সংরক্ষণ করা হয়েছে!');
             } catch (error) {
                console.error("Error saving attendance: ", error);
                showModal('ত্রুটি', 'হাজিরা সংরক্ষণ করতে সমস্যা হয়েছে।');
             }
        });

        // --- Settings Page ---
        const settingsTitle = document.getElementById('settings-title');
        const settingsMain = document.getElementById('settings-main');
        const settingsContent = document.getElementById('settings-content');
        const settingsBackButton = document.getElementById('settings-back-btn');
        const studentModalEl = document.getElementById('student-modal');

        function navigateSettings(subpageId) {
            settingsMain.innerHTML = '';
            settingsMain.style.display = 'none';

            let subpageContainer = document.getElementById(`settings-${subpageId}`);
            if (!subpageContainer) {
                subpageContainer = document.createElement('div');
                subpageContainer.id = `settings-${subpageId}`;
                subpageContainer.className = 'bg-gray-800 p-6 rounded-lg';
                settingsContent.appendChild(subpageContainer);
            }

            document.querySelectorAll('#settings-content > div:not(#settings-main)').forEach(p => p.classList.add('hidden'));
            subpageContainer.classList.remove('hidden');
            settingsBackButton.classList.remove('hidden');

            const subpageTitles = {
                jamats: "জামাত ও কিতাব ব্যবস্থাপনা",
                students: "শিক্ষার্থী ব্যবস্থাপনা",
                years: "শিক্ষাবর্ষ ব্যবস্থাপনা"
            };
            settingsTitle.textContent = subpageTitles[subpageId];
            
            if(subpageId === 'jamats') renderSettingsJamats();
            if(subpageId === 'students') renderSettingsStudents();
            if(subpageId === 'years') renderSettingsYears();
        }

        settingsBackButton.addEventListener('click', renderSettingsMain);

        function renderSettingsMain() {
            settingsMain.style.display = 'block';
             document.querySelectorAll('#settings-content > div:not(#settings-main)').forEach(el => el.remove());
            settingsBackButton.classList.add('hidden');
            settingsTitle.textContent = 'সেটিংস';

            settingsMain.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-lg mb-6">
                    <label for="font-selector" class="block text-sm font-medium text-gray-300 mb-2">অ্যাপ্লিকেশন ফন্ট পরিবর্তন করুন</label>
                    <select id="font-selector" class="w-full md:w-1/3 bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 text-white">
                        <option value="hind-siliguri">হিন্দ শিলিগুড়ি</option>
                        <option value="solaiman">সোলাইমান লিপি</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div data-subpage="jamats" class="settings-card bg-gray-800 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-gray-700 hover:shadow-cyan-500/20 shadow-lg transition-all duration-300 transform hover:-translate-y-2">
                        <div class="text-cyan-400 mb-4">${navItems.find(i=>i.id==='introduction').icon.replace('class="lucide', 'class="lucide w-10 h-10"')}</div>
                        <h3 class="text-xl font-bold text-white mb-2">জামাত ও কিতাব</h3>
                    </div>
                     <div data-subpage="students" class="settings-card bg-gray-800 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-gray-700 hover:shadow-cyan-500/20 shadow-lg transition-all duration-300 transform hover:-translate-y-2">
                        <div class="text-cyan-400 mb-4">${navItems.find(i=>i.id==='attendance').icon.replace('user','users').replace('class="lucide', 'class="lucide w-10 h-10"')}</div>
                        <h3 class="text-xl font-bold text-white mb-2">শিক্ষার্থী ব্যবস্থাপনা</h3>
                    </div>
                     <div data-subpage="years" class="settings-card bg-gray-800 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-gray-700 hover:shadow-cyan-500/20 shadow-lg transition-all duration-300 transform hover:-translate-y-2">
                        <div class="text-cyan-400 mb-4">${navItems.find(i=>i.id==='reports').icon.replace('download','calendar').replace('class="lucide', 'class="lucide w-10 h-10"')}</div>
                        <h3 class="text-xl font-bold text-white mb-2">শিক্ষাবর্ষ</h3>
                    </div>
                </div>
            `;
            const fontSelector = document.getElementById('font-selector');
            fontSelector.value = localStorage.getItem('preferredFont') || 'hind-siliguri';
        }

        function renderSettingsYears() {
            let container = document.getElementById('settings-years');
            container.innerHTML = `
                <h3 class="text-xl font-bold text-white">শিক্ষাবর্ষ যোগ করুন</h3>
                <form id="year-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mt-4">
                    <input type="text" id="year-hijri" placeholder="হিজরি শিক্ষাবর্ষ (যেমন ১৪৪৬/১৪৪৭)" required class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600" />
                    <input type="text" id="year-gregorian" placeholder="খ্রিস্টাব্দ শিক্ষাবর্ষ (যেমন ২০২৫/২০২৬)" required class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600" />
                    <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2">
                        <span>যোগ করুন</span>
                    </button>
                </form>
                <div class="mt-6">
                    <h3 class="text-xl font-bold text-white mb-4">সংরক্ষিত শিক্ষাবর্ষসমূহ</h3>
                    <ul id="years-list" class="space-y-2"></ul>
                </div>
            `;
            renderYearsList();
        }

        function renderYearsList() {
            const listEl = document.getElementById('years-list');
            if(!listEl) return;
            listEl.innerHTML = state.academicYears.map(year => `
                <li key="${year.id}" class="bg-gray-700 p-3 rounded-md flex justify-between items-center">
                    <span class="text-white">${year.hijri} (${year.gregorian})</span>
                    <button data-id="${year.id}" class="delete-year-btn text-red-500 hover:text-red-400">
                        <svg class="lucide lucide-trash-2" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="m8 6 4-4 4 4"/></svg>
                    </button>
                </li>
            `).join('');
        }
        
        function renderSettingsStudents() {
            let container = document.getElementById('settings-students');
            const sortedStudents = [...state.students].sort((a,b) => (a.roll || 0) - (b.roll || 0));
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                     <h3 class="text-xl font-bold text-white">শিক্ষার্থী তালিকা</h3>
                     <button id="add-student-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                        <span>নতুন শিক্ষার্থী</span>
                     </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">রোল</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">নাম</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">জামাত</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">কার্যক্রম</th>
                            </tr>
                        </thead>
                        <tbody class="bg-gray-800 divide-y divide-gray-700">
                           ${sortedStudents.map(student => `
                               <tr key="${student.id}">
                                   <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${student.roll}</td>
                                   <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${student.name}</td>
                                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${state.jamats[student.jamatId]?.name || 'N/A'}</td>
                                   <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                       <button data-id="${student.id}" class="edit-student-btn text-cyan-400 hover:text-cyan-300 mr-4"><svg class="lucide lucide-edit" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                       <button data-id="${student.id}" class="delete-student-btn text-red-500 hover:text-red-400"><svg class="lucide lucide-trash-2" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="m8 6 4-4 4 4"/></svg></button>
                                   </td>
                               </tr>
                           `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderSettingsJamats() {
            const container = document.getElementById('settings-jamats');
            const jamatId = state.editingJamatId;

            if (jamatId) {
                const currentJamat = state.jamats[jamatId];
                const kitabNames = state.kitabNamesCache;
                container.innerHTML = `<h4 class="text-lg font-bold text-cyan-400 mb-4">${currentJamat.name} - কিতাব সম্পাদনা</h4><div id="kitab-list" class="space-y-2">${kitabNames.map((name, index) => `<div class="flex items-center space-x-2"><input type="text" value="${name}" data-index="${index}" class="kitab-name-input w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600"/><button data-index="${index}" class="remove-kitab-btn p-2 bg-red-600 hover:bg-red-700 rounded-md text-white"><svg class="lucide lucide-trash-2" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="m8 6 4-4 4 4"/></svg></button></div>`).join('')}</div><button id="add-kitab-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2"><span>নতুন কিতাব</span></button><div class="flex justify-end space-x-4 pt-4 mt-4 border-t border-gray-700"><button id="cancel-kitab-edit" class="py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-md text-white">বাতিল</button><button id="save-kitab-edit" class="py-2 px-4 bg-cyan-600 hover:bg-cyan-700 rounded-md text-white">সংরক্ষণ করুন</button></div>`;
            } else {
                 container.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-white">জামাত তালিকা</h3>${Object.keys(state.jamats).length === 0 ? `<button id="init-jamats-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">ডিফল্ট জামাত যোগ করুন</button>` : ''}</div><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">${Object.entries(state.jamats).map(([id, jamat]) => `<div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center"><div><p class="font-bold text-lg text-white">${jamat.name}</p><p class="text-sm text-gray-400">${jamat.kitabCount} টি কিতাব</p></div><button data-id="${id}" class="edit-jamat-btn text-cyan-400 hover:text-cyan-300"><svg class="lucide lucide-edit" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button></div>`).join('')}</div>`;
            }
        }
        
        settingsContent.addEventListener('click', async e => {
            const target = e.target.closest('button, select');
            if (!target) return;
            const id = target.id;
            const classList = target.classList;
            const dataset = target.dataset;

            if(id === 'font-selector') { applyFont(target.value); return; }
            if (classList.contains('settings-card')) { navigateSettings(dataset.subpage); return; }
            if (id === 'init-jamats-btn') { showModal("নিশ্চিতকরণ", "এটি ডাটাবেসের সমস্ত জামাত মুছে ফেলে ডিফল্ট ডেটা যোগ করবে। আপনি কি নিশ্চিত?", async () => { const batch = writeBatch(db); Object.entries(initialJamats).forEach(([id, data]) => batch.set(doc(db, `${basePath}/jamats`, id), data)); await batch.commit(); showModal("সফল", "ডিফল্ট জামাত যোগ করা হয়েছে।"); }); return; }
            if (classList.contains('edit-jamat-btn')) { state.editingJamatId = dataset.id; const jamat = state.jamats[state.editingJamatId]; state.kitabNamesCache = jamat.kitabNames || Array.from({length: jamat.kitabCount}, (_,i) => `কিতাব নং ${i+1}`); renderSettingsJamats(); return; }
            if (id === 'cancel-kitab-edit') { state.editingJamatId = null; renderSettingsJamats(); return; }
            if (id === 'add-kitab-btn') { state.kitabNamesCache.push(`নতুন কিতাব ${state.kitabNamesCache.length + 1}`); renderSettingsJamats(); return; }
            if (classList.contains('remove-kitab-btn')) { state.kitabNamesCache.splice(dataset.index, 1); renderSettingsJamats(); return; }
            if (id === 'save-kitab-edit') { const jamatRef = doc(db, `${basePath}/jamats`, state.editingJamatId); const newKitabNames = Array.from(document.querySelectorAll('.kitab-name-input')).map(input => input.value); try { await updateDoc(jamatRef, { kitabNames: newKitabNames, kitabCount: newKitabNames.length }); showModal('সফল', 'সফলভাবে সংরক্ষণ করা হয়েছে!'); state.editingJamatId = null; renderSettingsJamats();} catch (err) { showModal("ত্রুটি", "সংরক্ষণে সমস্যা হয়েছে।"); } return; }
            if (id === 'add-student-btn') { openStudentModal(); return; }
            if (classList.contains('edit-student-btn')) { openStudentModal(state.students.find(s => s.id === dataset.id)); return; }
            if (classList.contains('delete-student-btn')) { showModal('নিশ্চিতকরণ', 'আপনি কি নিশ্চিতভাবে এই শিক্ষার্থীকে মুছে ফেলতে চান?', async () => { await deleteDoc(doc(db, `${basePath}/students`, dataset.id)); showModal('সফল', 'শিক্ষার্থীকে সফলভাবে মুছে ফেলা হয়েছে।'); }); return; }
            if (classList.contains('delete-year-btn')) { showModal("নিশ্চিতকরণ", "আপনি কি নিশ্চিতভাবে এই শিক্ষাবর্ষটি মুছে ফেলতে চান?", async () => { await deleteDoc(doc(db, `${basePath}/academicYears`, dataset.id)); showModal("সফল", "শিক্ষাবর্ষটি মুছে ফেলা হয়েছে।"); }); return; }
        });
        
        settingsContent.addEventListener('submit', async e => {
            if (e.target.id === 'year-form') { e.preventDefault(); const hijri = e.target.querySelector('#year-hijri').value; const gregorian = e.target.querySelector('#year-gregorian').value; try { await addDoc(collection(db, `${basePath}/academicYears`), { hijri, gregorian }); showModal("সফল", "শিক্ষাবর্ষ সফলভাবে যোগ করা হয়েছে।"); e.target.reset(); } catch (err) { showModal("ত্রুটি", "শিক্ষাবর্ষ যোগ করতে সমস্যা হয়েছে।"); } }
        });

        function openStudentModal(student=null){ const form = document.getElementById('student-form'); form.reset(); if(student){ form.querySelector('#student-modal-title').textContent='শিক্ষার্থী সম্পাদনা করুন'; form.querySelector('#student-id').value=student.id; form.querySelector('#student-name').value=student.name; form.querySelector('#student-roll').value=student.roll; form.querySelector('#student-jamat').value=student.jamatId; form.querySelector('#student-modal-submit').textContent='আপডেট করুন';} else { form.querySelector('#student-modal-title').textContent='নতুন শিক্ষার্থী যোগ করুন'; form.querySelector('#student-id').value=''; form.querySelector('#student-modal-submit').textContent='যোগ করুন';} studentModalEl.classList.add('is-open'); }
        document.getElementById('student-modal-cancel').addEventListener('click', ()=>studentModalEl.classList.remove('is-open'));
        document.getElementById('student-form').addEventListener('submit', async e => { e.preventDefault(); const form = e.target; const studentData = { name: form.querySelector('#student-name').value, roll: Number(form.querySelector('#student-roll').value), jamatId: form.querySelector('#student-jamat').value }; const studentId = form.querySelector('#student-id').value; try { if(studentId) await updateDoc(doc(db, `${basePath}/students`, studentId), studentData); else await addDoc(collection(db, `${basePath}/students`), studentData); showModal('সফল', `শিক্ষার্থীর তথ্য সফলভাবে ${studentId ? 'আপডেট' : 'যোগ'} করা হয়েছে।`); studentModalEl.classList.remove('is-open'); } catch (err) { showModal('ত্রুটি', 'শিক্ষার্থীর তথ্য সংরক্ষণে সমস্যা হয়েছে।'); } });
        

        // --- Reports Page ---
        const repYear = document.getElementById('rep-year');
        const repExam = document.getElementById('rep-exam');
        const repJamat = document.getElementById('rep-jamat');
        const fetchBtn = document.getElementById('fetch-report-data-btn');
        const downloadBtns = document.getElementById('report-download-buttons');
        
        fetchBtn.addEventListener('click', async () => {
             const year = repYear.value, exam = repExam.value, jamat = repJamat.value;
             if (!year || !exam || !jamat) { showModal("ত্রুটি", "অনুগ্রহ করে সকল তথ্য নির্বাচন করুন।"); return; }
             fetchBtn.textContent = 'লোড হচ্ছে...'; fetchBtn.disabled = true;
             const attendanceId = `${year}_${exam.replace(/\s/g, '-')}_${jamat}`;
             const attendanceRef = doc(db, `${basePath}/attendance`, attendanceId);
             const docSnap = await getDoc(attendanceRef);
             if (docSnap.exists()) { state.reportData = docSnap.data(); downloadBtns.classList.remove('hidden'); } 
             else { state.reportData = null; downloadBtns.classList.add('hidden'); showModal("ডেটা নেই", "এই নির্বাচনের জন্য কোনো হাজিরা ডেটা পাওয়া যায়নি।"); }
             fetchBtn.textContent = 'ডেটা আনুন'; fetchBtn.disabled = false;
        });

        document.getElementById('download-pdf-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.addFileToVFS('SolaimanLipi.ttf', SolaimanLipi.font);
            doc.addFont('SolaimanLipi.ttf', 'SolaimanLipi', 'normal');
            doc.setFont('SolaimanLipi');
            
            const currentJamat = state.jamats[state.reportData.jamatId];
            const currentYear = state.academicYears.find(y => y.id === state.reportData.yearId);
            const kitabNames = currentJamat?.kitabNames || [];
            const filteredStudents = state.students.filter(s => s.jamatId === state.reportData.jamatId).sort((a,b) => (a.roll || 0) - (b.roll || 0));

            doc.setFontSize(18);
            doc.text('জামিয়া হাসানিয়া কওমীয়া মাদরাসা ও এতিমখানা', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('রঘুনাথপুর, শিঙ্গাশোলপুর, কালিয়া, নড়াইল', doc.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
            doc.setFontSize(11);
            doc.text(`শিক্ষাবর্ষ: ${currentYear?.hijri || ''}`, 20, 40);
            doc.text(`জামাত: ${currentJamat?.name || ''}`, 20, 46);
            doc.text(`পরীক্ষা: ${state.reportData.examType}`, 20, 52);
            doc.text(`তারিখ: ${new Date(state.reportData.date).toLocaleDateString('bn-BD')}`, 20, 58);

            const head = [['ক্রমিক নং', 'ছাত্রের নাম', ...kitabNames]];
            const body = filteredStudents.map((student, index) => {
                const studentAtt = state.reportData.records[student.id] || {};
                return [index + 1, student.name, ...kitabNames.map((_, i) => studentAtt[i] === 'present' ? 'P' : (studentAtt[i] === 'absent' ? 'A' : '-'))];
            });

            doc.autoTable({ startY: 65, head, body, theme: 'grid', headStyles: { font: 'SolaimanLipi' }, bodyStyles: { font: 'SolaimanLipi' }});
            doc.save(`${currentJamat.name}_Report.pdf`);
        });
        
        document.getElementById('download-excel-btn').addEventListener('click', () => {
            const currentJamat = state.jamats[state.reportData.jamatId];
            const kitabNames = currentJamat?.kitabNames || [];
            const filteredStudents = state.students.filter(s => s.jamatId === state.reportData.jamatId).sort((a,b) => (a.roll || 0) - (b.roll || 0));
            const wsData = [['ক্রমিক নং', 'রোল', 'ছাত্রের নাম', ...kitabNames], ...filteredStudents.map((student, index) => { const studentAtt = state.reportData.records[student.id] || {}; return [index + 1, student.roll, student.name, ...kitabNames.map((_, i) => studentAtt[i] === 'present' ? 'উপস্থিত' : (studentAtt[i] === 'absent' ? 'অনুপস্থিত' : 'N/A')) ]; })];
            const wb = window.XLSX.utils.book_new();
            const ws = window.XLSX.utils.aoa_to_sheet(wsData);
            window.XLSX.utils.book_append_sheet(wb, ws, "হাজিরা রিপোর্ট");
            window.XLSX.writeFile(wb, `${currentJamat.name}_Report.xlsx`);
        });

        // --- Font Switcher Logic ---
        function applyFont(fontName) {
            document.body.classList.remove('font-solaiman', 'font-hind-siliguri');
            if (fontName === 'solaiman') {
                document.body.classList.add('font-solaiman');
            } else {
                document.body.classList.add('font-hind-siliguri');
            }
            localStorage.setItem('preferredFont', fontName);
        }

        settingsContent.addEventListener('change', e => {
            if (e.target.id === 'font-selector') {
                applyFont(e.target.value);
            }
        });


        // --- Auth & Initialization Flow ---
        function initializeDataListeners() {
            if (!state.userId) return;
            onSnapshot(collection(db, `${basePath}/academicYears`), s => { state.academicYears = s.docs.map(d=>({id: d.id, ...d.data()})); populateSelect(attYearSelect, state.academicYears, 'id', i=>`${i.hijri} (${i.gregorian})`); populateSelect(repYear, state.academicYears, 'id', i=>`${i.hijri} (${i.gregorian})`); if(state.academicYears.length > 0 && !state.selectedFilters.year) { state.selectedFilters.year = state.academicYears[0].id; attYearSelect.value = state.selectedFilters.year; repYear.value = state.selectedFilters.year; } if(state.currentPage === 'settings') renderSettingsYears(); });
            onSnapshot(collection(db, `${basePath}/jamats`), s => { state.jamats={}; const list=[]; s.docs.forEach(d=>{state.jamats[d.id]=d.data(); list.push({id:d.id,...d.data()})}); populateSelect(attJamatSelect,list,'id','name'); populateSelect(repJamat,list,'id','name'); populateSelect(document.getElementById('student-jamat'),list,'id','name'); if(list.length>0&&!state.selectedFilters.jamat){ state.selectedFilters.jamat=list[0].id; attJamatSelect.value=list[0].id; repJamat.value=list[0].id; fetchAttendance(); } if(state.currentPage === 'settings') renderSettingsJamats(); });
            onSnapshot(collection(db, `${basePath}/students`), s => { state.students = s.docs.map(d=>({id: d.id, ...d.data()})); if(state.currentPage==='attendance') renderAttendanceTable(); if(state.currentPage==='settings') renderSettingsStudents(); });
            
            loader.style.display = 'none';
            navigate('home');
        }

        async function main() {
            // Apply saved font preference on load
            const savedFont = localStorage.getItem('preferredFont') || 'hind-siliguri';
            applyFont(savedFont);

            renderNav();
            renderHome();
            populateSelect(attExamSelect, examTypes.map(e=>({id:e,name:e})),'id','name',{placeholder:'পরীক্ষা নির্বাচন করুন'});
            attExamSelect.value = state.selectedFilters.exam;
            populateSelect(repExam, examTypes.map(e=>({id:e,name:e})),'id','name',{placeholder:'পরীক্ষা নির্বাচন করুন'});
            repExam.value = examTypes[0];

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    if (!state.userId) { // Initialize only once
                        state.userId = user.uid;
                        initializeDataListeners();
                    }
                } else {
                    try {
                        const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (customToken) {
                           await signInWithCustomToken(auth, customToken);
                        } else {
                           await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        showModal("ত্রুটি", "সিস্টেমে প্রবেশ করতে সমস্যা হচ্ছে। ইন্টারনেট সংযোগ পরীক্ষা করে দেখুন।");
                        loader.textContent = "সিস্টেমে প্রবেশ করা সম্ভব হচ্ছে না।";
                    }
                }
            });
        }
        
        // --- Entry Point ---
        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>
